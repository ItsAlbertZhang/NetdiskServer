# 项目开发手册

## 项目需求

#### 一期工程

1. 实现服务端与客户端的连接, 能响应客户端的简单命令.

* 进入对应目录
* 列出目录下的文件
* 下载目录下的文件
* 上传目录下的文件
* 删除目录下的文件
* 显示当前目录

#### 二期工程

1. 实现用户管理系统, 包括:

* 用户的注册与登录
* 为每个用户单独维护目录与文件
* 保证用户连接时的安全性

2. 实现服务端的日志记录.

3. 实现断点续传功能.

4. 在传输大文件时, 使用高效传输策略 (如 mmap 或 sendfile/splice)

#### 三期工程

1. 将用户管理系统升级为数据库依赖, 使用数据库管理用户信息.

2. 将文件系统升级为数据库依赖, 使用数据库管理文件, 并实现文件秒传.

#### 四期工程

1. 实现长响应时间(上传/下载)命令与短响应时间(进入目录等)命令的异步分离.

2. 当客户端长时间无操作时, 服务端自动断开.

#### 其他功能

1. 对大文件实现 UDP 协议传输.

2. 服务端能够响应简单的命令.

## 项目设计

### 功能设计

针对需求中对功能提出的要求, 进行以下设计:

#### 登录系统

服务端磁盘(数据库)中存储用户密码的 sha512 密文.

服务端与客户端保存一对 RSA 密钥, 其中私钥保存在服务端, 公钥保存在客户端. 进行连接时, 客户端对密码明文使用公钥进行加密并发送给服务端, 服务端对接收到的密文使用私钥进行解密得到明文, 之后对明文执行 sha512 哈希得到密文, 将得到的密文与磁盘中存储的密文进行对比, 即可验证客户端身份.

在公钥发生改变时, 客户端会发出警告, 并给出更改后公钥的指纹信息.

通过以上设计, 最大程度地在网络传输环节和数据存储环节减少了密码明文泄露的可能性.

依旧存在的安全隐患: 如果黑客获取了客户端经公钥加密的密文, 则其可以冒充客户端的用户身份进行登录.

解决方案: 在客户端将密码明文使用公钥加密并发送之前, 令服务端随机生成一段会话窗口特征值并明文发送给客户端. 客户端在接收到会话窗口特征值后, 先用密码异或该特征值获得密文, 然后再将密文发出. 服务端在接收到密文并解密后, 再异或该特征值即可获得密码明文.

依旧存在的(且无法解决的)安全隐患: 如果黑客攻破了服务器, 获取到私钥, 并获取了会话窗口特征值与密文, 则其可以获取到密码明文.

需求数据库资源: 用户信息表.

#### 文件系统

需求数据库资源: 文件信息表

#### 长短命令的异步分离

服务端主线程负责响应来自所有客户端的短命令, 子线程负责响应长命令.

客户端在用户输入命令时对命令进行解析. (做点正事吧客户端) 如果命令为短命令则正常与服务端进行通信, 如果命令为长命令则拉起一个子线程负责该长命令的执行.

##### 显示进度

客户端主线程响应命令 `showpg` , 当用户输入该命令时每秒刷新一次子线程进度.

##### 连接安全

由于长短命令可以并行进行, 因此每有一个长命令处于执行状态, 客户端与服务端的连接数就 +1. 在进行连接时需要进行身份验证, 然而传统的身份验证每次都需要服务端生成一次窗口特征值, 而两端需要三次通信 (客户端发出连接请求, 服务器生成并发回窗口特征值, 客户端发出密文), 并且服务端需要与数据库内的密码密文进行比对, 才能确认客户端的身份. 

可以采用 token 令牌的方式来使三次通信简化为一次通信, 并且服务端无需连接数据库对密码密文进行比对.

在客户端与服务端第一次连接并验证身份完毕时 (或第一次执行长命令时), 客户端生成一对 RSA 密钥, 自己留下私钥, 并将公钥发送至服务器. 服务器在接收到公钥后, 随机生成一段 token, 再随机生成一段 salt, 并将二者使用公钥加密后发回客户端. 

客户端在需要建立新连接时, 发送一段含有 `token + 时间戳 + 会话窗口特征值 + 三者加盐加密` 的信息, 服务端在接收信息后, 根据会话窗口特征值 取出盐值, 并对明密文和时间戳进行对比. 对比验证通过后可直接建立新连接.

#### 自动断开

使用轮盘法可以实现客户端的超时自动断开.

以超过 30 秒未操作自动断开为例, 使用一个大小为 30 的循环队列 (30格轮盘), 并将 epoll 的等待时间设定为 1 秒.

每当客户端操作时, 将其从轮盘里之前的格子中拿出, 放在最新的格子中. 每次从 epoll 中唤醒时, 检查当前时间. 如果与上一次不同, 轮盘转至下一格. 如果下一格中存在客户端连接, 则说明该客户端已超时, 可以断开其连接.

##### 自动重连

断开 socket 连接后, 连接信息并不会立即被释放, 而是将其状态标为睡眠. 在睡眠状态下时, 客户端可以通过 token 直接重新连接, 而无需输入密码.

每当处于睡眠状态下的进程足够多时, 按照睡眠的时间顺序清理断开连接较久的一部分.

### 流程设计

### 协议设计
